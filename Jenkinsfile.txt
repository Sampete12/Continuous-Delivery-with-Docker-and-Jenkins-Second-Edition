pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                git credentialsId: 'your-git-credentials-id', url: 'your-repository-url'
            }
        }

        stage('Build') {
            steps {
                echo 'Building...'
                // Simulate build steps
                sh 'echo "Build complete"'
            }
        }

        stage('Unit Tests') {
            steps {
                echo 'Running Unit Tests...'
                // Simulate unit tests
                sh 'echo "Unit tests passed"'
            }
        }

        stage('Code Coverage') {
            when {
                branch 'main'
            }
            steps {
                echo 'Running Code Coverage...'
                // Simulate code coverage
                sh 'echo "Code coverage report generated"'
            }
        }

        stage('Feature Tests') {
            when {
                branch pattern: 'feature.*', result: true
            }
            steps {
                echo 'Running Feature Tests...'
                // Simulate feature tests
                sh 'echo "Feature tests passed"'
            }
        }

        stage('Fail on Other Branches') {
            when {
                not {
                    anyOf {
                        branch 'main'
                        branch pattern: 'feature.*', result: true
                    }
                }
            }
            steps {
                error('Branch name does not match allowed patterns.')
            }
        }
    }
}